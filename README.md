# Генератор прямоугольных импульсов

Простейший генератор прямоугольных импульсов на микроконтроллере ATmega328P, в составе аппаратной платформы Arduino Pro mini.

Используется для восстановления микроконтроллеров AVR после ошибочной установки fuse битов на тактирование от внешнего генератора.

Сигнал генерируется на выводе PB1 (arduino pin 9).

Для генерации импульсов используется CTC режим таймера T0. Вывод OC1A переключается в противоположное состояние при достижении значения в регистре `OCR1A`. Частота задается установкой значения в регистре `OCR1A` в соответствии с таблицей:

| OCR1A  |   0   |   1   |    2    |   3   |    4    |
|--------|-------|-------|---------|-------|---------|
| Focr1a | 4 MHz | 2 MHz | 1.3 MHz | 1 MHz | 800 kHz |

| OCR1A  |    5    |    6    |    7    |    8    |    9    |
|--------|---------|---------|---------|---------|---------|
| Focr1a | 666 kHz | 571 kHz | 500 kHz | 444 kHz | 400 kHz |

Частота расчитывается по формуле:

```
Focr1a = F_CPU / (2 * (OCR1A + 1))
```

Частота кварцевого резонатора F_CPU = 8 МГц.

По умолчанию выставлена частота 1 МГц. Для установки другой частоты нужно изменить значение регистра `OCR1A` и перекомпилировать программу.

Светодиод на выводе PB5 мигает с частотой 1 Гц, просто сигнализируя о работе микроконтроллера.

Прерывания не используются.

TODO:

- измерение частоты через UART;
- сохранение настроек в EEPROM.

## Подготовка окружения

Для компиляции программ на языке C для микроконтроллеров AVR используется AVR GCC toolchain.

1. Тулчейн AVR GCC для Windows можно скачать, например, [здесь](https://blog.zakkemble.net/avr-gcc-builds/) ([GitHub](https://github.com/ZakKemble/avr-gcc-build/releases)).
2. Тулчейн необходимо распаковать в директорию `c:\avr-gcc`. 
3. Добавить директорию `c:\avr-gcc\bin` в переменную среды `path`.
4. Склонировать себе этот репозиторий.

Исходники проекта хранятся в папке `src`. Заголовочные файлы в `inc`. Скомпилированные файлы будут лежать в папке `build`.

## Сборка проекта и прошивка микроконтроллера

Для сборки проекта необходимо во встроенном терминале VSCODE (Ctrl+Shift+\`) выполнить команду 

```
make
```

В результате в папке `buld` будут созданы следующие файлы: сама прошивка `.hex`, EEPROM `.epp`, ассемблерный листинг `.lss`.

Для прошивки микроконтррллера испольуется следующая команда:

```
make prog
```

> [!NOTE]
> Перед выполнением данной команды необходимо указать правильный порт программатора Avrdude, к которому подключена плата arduino. См. опцию `PORT` в файле `Makefile`.

Другие цели сборки:

- `make read_eeprom` - считает содержимое EEPROM памяти микроконтроллера;
- `make write_eeprom` - запишет память EEPROM микроконтроллера;
- `make size` - покажет размер прошивки;
- `make analyze` - анализ структуры пришивки;
- `make clean` - очистка.
